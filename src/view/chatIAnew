import requests
from view.vue_abstraite import VueAbstraite

API_URL = "https://ensai-gpt-109912438483.europe-west4.run.app/generate"


class ChatNew(VueAbstraite):
    """
    Vue permettant de démarrer un chat avec l'IA.
    Reçoit un premier message utilisateur, l'envoie à l'API ensaiGPT,
    et renvoie la réponse.
    """

    def __init__(self, user_message: str):
        self.user_message = user_message

    def choisir_menu(self):
        # Historique minimal : un prompt système + le message utilisateur
        payload = {
            "history": [
                {"role": "system", "content": "Tu es un assistant utile."},
                {"role": "user", "content": self.user_message},
            ],
            "temperature": 0.7,
            "top_p": 1.0,
            "max_tokens": 200,
        }

        try:
            response = requests.post(API_URL, json=payload)
            if response.status_code == 200:
                ai_response = response.json()
                print("\n--- Réponse de l'IA ---\n")
                print(ai_response)
                message = f"L'IA a répondu à votre question."
            else:
                print("Erreur :", response.status_code, response.text)
                message = "Une erreur est survenue avec l'API ensaiGPT."
        except Exception as e:
            print("Erreur de connexion :", e)
            message = "Impossible de contacter l'IA."

        # Retourner au menu utilisateur après affichage
        from view.menu_utilisateur_vue import MenuUtilisateurVue
        return MenuUtilisateurVue(message)
